# --- INPUT: Cấu hình để consume tin nhắn từ RabbitMQ ---
input {
  rabbitmq {
    # Tên host là tên dịch vụ trong docker-compose
    host => "rabbitmq" 
    port => 5672
    user => "user"
    password => "password"
    queue => "logstash_queue" 
    vhost => "/"
    durable => true 
    exchange => "logstash_exchange"
  }
}

# --- FILTER: Xử lý dữ liệu ---
filter {
  # Giả sử Backend/Producer gửi dữ liệu dưới dạng JSON
  json {
    source => "message"
    remove_field => ["message"] 
  }
  # Ví dụ: Thêm trường timestamp khi dữ liệu được xử lý
  mutate {
    add_field => { "processed_by_logstash_at" => "%{@timestamp}" }
  }
}

# --- OUTPUT: Đẩy dữ liệu vào Elasticsearch ---
output {
  elasticsearch {
    # Kết nối đến container Elasticsearch
    hosts => ["elasticsearch:9200"] 
    # Index sẽ được đặt tên theo ngày
    index => "booking-events-%{+YYYY.MM.dd}"
    # Không cần xác thực do đã tắt security trong docker-compose
  }
  # Output ra console Logstash để tiện theo dõi/debug
  stdout { codec => rubydebug } 
}